# 주문 생성 흐름 점검 보고서

## 📋 개요

고객 페이지에서 주문 생성 시 관리자 페이지에서 확인 가능 여부 및 알림 기능 구현 상태를 점검한 결과를 정리합니다.

## ✅ 수정 완료 사항

### 1. 주문 데이터베이스 저장 기능 추가

**문제점:**
- 고객 페이지에서 주문 생성 시 `sendOrderToN8N`만 호출하여 n8n 웹훅으로만 전송
- Railway 백엔드의 `createOrder` API를 호출하지 않아 데이터베이스에 저장되지 않음
- 관리자 페이지에서 주문을 확인할 수 없음

**해결 방법:**
- `OrderForm.tsx`에서 주문 생성 시:
  1. **Railway 백엔드에 주문 저장** (`createOrder` API 호출)
  2. 로컬 스토어에 추가 (UI 업데이트용)
  3. n8n 웹훅으로 알림 전송 (비동기, 실패해도 주문은 저장됨)

**수정된 파일:**
- `components/features/OrderForm.tsx`
  - `token` prop 추가
  - `createOrder` import 추가
  - `handleSubmit`에서 주문 저장 로직 추가
- `components/guest/GuestOrderContent.tsx`
  - `OrderForm`에 `token` prop 전달

## 📊 현재 데이터 흐름

### 고객 페이지 주문 생성

```
고객 페이지 (OrderForm)
  ↓
1. Railway 백엔드 API 호출
   POST /api/guest/:token/orders
   → PostgreSQL 데이터베이스에 주문 저장
   → 주문 ID 반환
  ↓
2. 로컬 스토어 업데이트
   → UI 즉시 반영
  ↓
3. n8n 웹훅 호출 (비동기)
   POST /api/n8n/order
   → n8n 워크플로우 트리거
   → 알림 발송 (알림톡 등)
```

### 관리자 페이지 주문 조회

```
관리자 페이지 (OrdersPage)
  ↓
Railway 백엔드 API 호출
  GET /api/admin/orders
  → PostgreSQL에서 주문 목록 조회
  → 상태별 필터링 (pending, preparing, delivering, completed)
  → 주문 목록 표시
```

## 🔍 기능별 구현 상태

### ✅ 완료된 기능

1. **고객 페이지 주문 생성**
   - ✅ 주문 폼 UI (`OrderForm.tsx`)
   - ✅ Railway 백엔드에 주문 저장 (`createOrder` API)
   - ✅ 로컬 스토어 업데이트
   - ✅ n8n 웹훅 알림 전송

2. **관리자 페이지 주문 조회**
   - ✅ 주문 목록 조회 (`getAdminOrders` API)
   - ✅ 상태별 필터링 (pending, preparing, delivering, completed)
   - ✅ 주문 상세 보기
   - ✅ 주문 상태 업데이트 (`updateOrderStatus` API)

3. **Railway 백엔드 API**
   - ✅ `POST /api/guest/:token/orders` - 주문 생성
   - ✅ `GET /api/admin/orders` - 주문 목록 조회
   - ✅ `PATCH /api/admin/orders/:id` - 주문 상태 업데이트
   - ✅ PostgreSQL 데이터베이스 저장/조회

### ⚠️ 확인 필요 사항

1. **n8n 워크플로우 설정**
   - n8n에서 `/order` 웹훅 엔드포인트가 설정되어 있는지 확인 필요
   - 알림톡 발송 워크플로우가 구성되어 있는지 확인 필요
   - 주문 알림 메시지 템플릿 확인 필요

2. **주문 알림 기능**
   - n8n 워크플로우에서 관리자에게 알림 발송 여부 확인
   - 알림톡 발송 기능 구현 여부 확인
   - 주문 상태 변경 시 고객에게 알림 발송 여부 확인

## 🔄 데이터 흐름 다이어그램

```
┌─────────────────┐
│  고객 페이지     │
│  (OrderForm)    │
└────────┬────────┘
         │
         │ 1. createOrder(token, orderData)
         ▼
┌─────────────────┐
│ Railway 백엔드   │
│ POST /guest/...  │
│ /orders          │
└────────┬────────┘
         │
         │ 2. PostgreSQL 저장
         ▼
┌─────────────────┐
│ PostgreSQL      │
│ orders 테이블    │
└────────┬────────┘
         │
         │ 3. 주문 ID 반환
         ▼
┌─────────────────┐
│  고객 페이지     │
│  (로컬 스토어)   │
└────────┬────────┘
         │
         │ 4. sendOrderToN8N (비동기)
         ▼
┌─────────────────┐
│ n8n 웹훅        │
│ /api/n8n/order   │
└────────┬────────┘
         │
         │ 5. n8n 워크플로우 트리거
         ▼
┌─────────────────┐
│ n8n 워크플로우   │
│ - 알림톡 발송    │
│ - 관리자 알림    │
└─────────────────┘

         │
         │ (관리자 페이지에서 조회)
         ▼
┌─────────────────┐
│  관리자 페이지   │
│  (OrdersPage)    │
└────────┬────────┘
         │
         │ GET /api/admin/orders
         ▼
┌─────────────────┐
│ Railway 백엔드   │
│ 주문 목록 조회   │
└────────┬────────┘
         │
         │ PostgreSQL 조회
         ▼
┌─────────────────┐
│ PostgreSQL      │
│ orders 테이블    │
└─────────────────┘
```

## 📝 테스트 체크리스트

### 고객 페이지 주문 생성 테스트

- [ ] 주문 폼에서 세트 선택 및 수량 지정
- [ ] 배송 시간 및 요청사항 입력
- [ ] 주문 제출 시 Railway 백엔드에 저장 확인
- [ ] 주문 저장 성공 시 성공 토스트 메시지 표시
- [ ] 주문 저장 실패 시 에러 토스트 메시지 표시
- [ ] n8n 웹훅 호출 확인 (선택사항, 실패해도 주문은 저장됨)

### 관리자 페이지 주문 조회 테스트

- [ ] 주문 목록이 정상적으로 표시되는지 확인
- [ ] 상태별 필터링이 정상 작동하는지 확인
- [ ] 주문 상세 보기가 정상 작동하는지 확인
- [ ] 주문 상태 업데이트가 정상 작동하는지 확인
- [ ] 새로고침 버튼이 정상 작동하는지 확인

### n8n 알림 테스트

- [ ] n8n 웹훅이 정상적으로 수신되는지 확인
- [ ] n8n 워크플로우가 정상적으로 실행되는지 확인
- [ ] 알림톡이 정상적으로 발송되는지 확인 (설정된 경우)
- [ ] 관리자 알림이 정상적으로 발송되는지 확인 (설정된 경우)

## 🚨 알려진 이슈 및 개선 사항

### 현재 상태

1. **주문 저장 기능**: ✅ 완료
   - Railway 백엔드에 주문이 정상적으로 저장됨
   - 관리자 페이지에서 주문 조회 가능

2. **n8n 알림 기능**: ⚠️ 확인 필요
   - n8n 웹훅은 호출되지만, 실제 워크플로우 설정 여부 확인 필요
   - 알림톡 발송 기능 구현 여부 확인 필요

### 개선 제안

1. **Railway 백엔드에서 n8n 알림 전송**
   - 현재는 프론트엔드에서 n8n 웹훅 호출
   - 백엔드에서 주문 생성 후 n8n 알림을 보내는 것이 더 안정적일 수 있음
   - 주문 생성 실패 시 알림이 발송되지 않도록 보장

2. **주문 상태 변경 시 알림**
   - 관리자가 주문 상태를 변경할 때 고객에게 알림 발송
   - 예: "준비 중" → "배송 중" → "완료" 상태 변경 시 알림

3. **주문 알림 로깅**
   - n8n 웹훅 호출 성공/실패 로그 기록
   - 주문 알림 발송 이력 관리

## 📌 결론

### 구현 완료 사항

✅ **주문 데이터베이스 저장**: 고객 페이지에서 주문 생성 시 Railway 백엔드에 저장되어 관리자 페이지에서 확인 가능

✅ **관리자 페이지 주문 조회**: 주문 목록 조회, 상태별 필터링, 주문 상세 보기, 상태 업데이트 기능 모두 정상 작동

✅ **n8n 웹훅 연동**: 주문 생성 시 n8n 웹훅으로 알림 전송 (비동기 처리)

### 확인 필요 사항

⚠️ **n8n 워크플로우 설정**: n8n에서 `/order` 웹훅 엔드포인트가 설정되어 있고, 알림톡 발송 워크플로우가 구성되어 있는지 확인 필요

⚠️ **알림 기능**: 실제 알림톡 발송이 정상적으로 작동하는지 테스트 필요

### 다음 단계

1. n8n 워크플로우 설정 확인 및 테스트
2. 알림톡 발송 기능 테스트
3. 주문 상태 변경 시 알림 기능 추가 (선택사항)
4. Railway 백엔드에서 n8n 알림 전송으로 이동 (선택사항)
