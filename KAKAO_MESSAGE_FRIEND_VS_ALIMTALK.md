# 카카오톡 메시지 발송 방식 비교 및 검증

## 📋 문제 상황

**현재 상황:**
- 카카오톡 "친구 목록/메시지" 기능 승인 완료
- 네이버 예약 시 게스트가 자동으로 카카오톡 친구로 추가되지 않음
- 친구톡은 친구로 추가된 사용자에게만 발송 가능

**문제:**
- 예약 완료 시 게스트에게 자동으로 메시지를 발송하려면 친구 추가가 필요
- 친구 추가는 수동 프로세스이므로 자동화 불가능

---

## 🔍 카카오톡 메시지 발송 방식 비교

### 1. 친구톡 (FriendTalk) - 현재 승인된 방식

**특징:**
- ✅ 무료
- ✅ 친구로 추가된 사용자에게만 발송 가능
- ❌ 친구 추가가 필수 (수동 프로세스)
- ❌ 일일 발송 한도 존재
- ❌ 스팸 필터 적용 가능

**API 엔드포인트:**
```
POST https://kapi.kakao.com/v1/api/talk/friends/message/default/send
```

**요구사항:**
- 친구 목록 조회 API로 친구 UUID 확인 필요
- 친구로 추가되지 않은 사용자에게는 발송 불가

**적용 시나리오:**
- 이미 친구로 추가된 고객에게만 발송 가능
- 신규 예약자에게는 발송 불가능

---

### 2. 알림톡 (AlimTalk) - 비즈니스용 메시지

**특징:**
- ✅ 친구 추가 불필요 (전화번호로 발송)
- ✅ 비즈니스 채널을 통한 발송
- ✅ 스팸 필터 없음
- ✅ 더 많은 발송량 가능
- ❌ 유료 (건당 과금)
- ❌ 템플릿 사전 등록 및 승인 필요
- ❌ 카카오 비즈니스 채널 생성 필요

**API 엔드포인트:**
```
POST https://kapi.kakao.com/v1/alimtalk/send
```

**요구사항:**
- 카카오 비즈니스 채널 생성
- 메시지 템플릿 사전 등록 및 승인
- 전화번호로 발송 (친구 추가 불필요)

**적용 시나리오:**
- 신규 예약자에게도 즉시 발송 가능
- 예약 완료 시 자동 발송 가능

---

## 💡 해결 방안

### 방안 1: 알림톡으로 전환 (권장)

**장점:**
- 친구 추가 불필요
- 예약 완료 시 즉시 자동 발송 가능
- 더 안정적인 메시지 전달

**단계:**
1. 카카오 비즈니스 채널 생성
2. 알림톡 템플릿 등록 및 승인
3. n8n 워크플로우 수정 (알림톡 API 사용)

**비용:**
- 건당 과금 (약 20-30원/건)
- 월 구독료 (채널 운영)

---

### 방안 2: 친구톡 + 친구 추가 프로세스

**장점:**
- 무료
- 현재 승인된 기능 활용

**단점:**
- 친구 추가가 수동 프로세스
- 자동화 불가능
- 신규 예약자에게 발송 불가

**적용 방법:**
1. 예약 완료 시 게스트에게 친구 추가 안내 메시지 발송 (SMS 또는 이메일)
2. 게스트가 수동으로 친구 추가
3. 친구 추가 후 카카오톡 메시지 발송

**문제점:**
- 친구 추가율이 낮을 수 있음
- 즉시 발송 불가능
- 추가 프로세스 필요

---

### 방안 3: 하이브리드 방식

**친구톡 + 알림톡 병행:**
- 친구로 추가된 고객: 친구톡 발송 (무료)
- 친구로 추가되지 않은 고객: 알림톡 발송 (유료)

**구현:**
1. 친구 목록 조회
2. 친구 목록에 있으면 친구톡 발송
3. 친구 목록에 없으면 알림톡 발송

---

## 🎯 권장 솔루션: 알림톡 전환

### 이유

1. **자동화 가능**
   - 예약 완료 시 즉시 자동 발송
   - 친구 추가 프로세스 불필요

2. **안정성**
   - 스팸 필터 없음
   - 더 높은 전달률

3. **확장성**
   - 신규 예약자에게도 발송 가능
   - 더 많은 발송량 지원

4. **비즈니스 적합성**
   - 예약 안내는 비즈니스 메시지에 적합
   - 템플릿을 통한 일관된 메시지 제공

---

## 📋 알림톡 전환 가이드

### 1단계: 카카오 비즈니스 채널 생성

1. [카카오 비즈니스](https://business.kakao.com/) 접속
2. 비즈니스 채널 생성
3. 채널 인증 완료

### 2단계: 알림톡 템플릿 등록

1. 카카오 비즈니스 콘솔 → **"알림톡"** → **"템플릿 관리"**
2. 새 템플릿 생성:
   - **템플릿명**: "예약 완료 안내"
   - **메시지 내용**:
     ```
     {{guest_name}}님, OUSCARAVAN 예약이 완료되었습니다!

     예약번호: {{reservation_number}}
     체크인: {{checkin_date}}
     체크아웃: {{checkout_date}}
     객실: {{room_type}}
     결제금액: {{amount}}원

     아래 링크를 클릭하여 컨시어지 서비스를 이용하세요.
     [컨시어지 서비스 이용하기]
     ```
   - **버튼**: 링크 버튼 추가
3. 템플릿 승인 대기 (1-2일)

### 3단계: n8n 워크플로우 수정

**HTTP Request 노드 수정:**

**Method**: `POST`  
**URL**: `https://kapi.kakao.com/v1/alimtalk/send`

**Headers:**
- `Authorization`: `Bearer {{ $env.KAKAO_ACCESS_TOKEN }}`
- `Content-Type`: `application/json`

**Body (JSON):**
```json
{
  "receiver_uuids": ["{{ $json.phone }}"],
  "template_code": "YOUR_TEMPLATE_CODE",
  "template_args": {
    "#{guest_name}": "{{ $json.guest }}",
    "#{reservation_number}": "{{ $json.reservationNumber }}",
    "#{checkin_date}": "{{ $json.checkin }}",
    "#{checkout_date}": "{{ $json.checkout }}",
    "#{room_type}": "{{ $json.room }}",
    "#{amount}": "{{ $json.amount }}"
  },
  "button": {
    "name": "컨시어지 서비스 이용하기",
    "url_mobile": "{{ $json.link }}",
    "url_pc": "{{ $json.link }}"
  }
}
```

**참고:**
- `receiver_uuids`: 전화번호 (하이픈 제거, 예: "01012345678")
- `template_code`: 승인받은 템플릿 코드
- `template_args`: 템플릿 변수 매핑

---

## 🔄 현재 친구톡 방식 검증

### 친구톡 사용 가능 시나리오

**시나리오 1: 기존 고객 (이미 친구 추가됨)**
- ✅ 친구톡 발송 가능
- ✅ 무료

**시나리오 2: 신규 고객 (친구 추가 안 됨)**
- ❌ 친구톡 발송 불가능
- ❌ 친구 추가 프로세스 필요

### 친구 추가 프로세스 검증

**방법 1: 수동 친구 추가**
1. 예약 완료 시 게스트 전화번호 확인
2. 카카오톡에서 수동으로 친구 추가
3. 친구 추가 후 메시지 발송

**문제점:**
- 자동화 불가능
- 시간 소요
- 친구 추가율 낮음

**방법 2: 친구 추가 요청**
1. 예약 완료 시 게스트에게 친구 추가 요청 메시지 발송 (SMS 또는 이메일)
2. 게스트가 수동으로 친구 추가
3. 친구 추가 확인 후 카카오톡 메시지 발송

**문제점:**
- 즉시 발송 불가능
- 친구 추가율 낮음
- 추가 프로세스 필요

---

## 📊 비교표

| 항목 | 친구톡 | 알림톡 |
|------|--------|--------|
| **비용** | 무료 | 유료 (건당 20-30원) |
| **친구 추가** | 필수 | 불필요 |
| **자동화** | 제한적 | 완전 자동화 가능 |
| **신규 고객** | 발송 불가 | 발송 가능 |
| **템플릿** | 불필요 | 사전 등록 필요 |
| **승인** | 추가 기능 승인 완료 | 템플릿 승인 필요 |
| **전달률** | 스팸 필터 적용 가능 | 높음 |
| **발송량** | 제한적 | 높음 |

---

## 🎯 최종 권장사항

### 단기 (현재 상황)

**친구톡 활용:**
- 기존 고객 (이미 친구 추가됨)에게만 발송
- 신규 고객은 이메일 또는 SMS로 안내
- 친구 추가 프로세스 안내 포함

### 중장기 (권장)

**알림톡 전환:**
1. 카카오 비즈니스 채널 생성
2. 알림톡 템플릿 등록 및 승인
3. n8n 워크플로우 수정
4. 모든 예약자에게 자동 발송

---

## 🔧 즉시 적용 가능한 해결책

### Option A: 친구톡 + 이메일/SMS 하이브리드

**워크플로우:**
```
예약 완료
  ↓
친구 목록 조회
  ↓
IF 친구 목록에 있음
  → 친구톡 발송
ELSE
  → 이메일 발송 (또는 SMS)
  → 친구 추가 안내 포함
```

### Option B: 알림톡 준비

1. 카카오 비즈니스 채널 생성 시작
2. 알림톡 템플릿 등록 및 승인 대기
3. 승인 완료 후 n8n 워크플로우 수정

---

## 📝 결론

**현재 상황:**
- 친구톡은 친구 추가가 필수이므로 신규 예약자에게 자동 발송 불가능
- 네이버 예약 시 자동 친구 추가 불가능

**권장 솔루션:**
- **알림톡 전환** (장기)
- **친구톡 + 이메일/SMS 하이브리드** (단기)

**다음 단계:**
1. 알림톡 전환 검토
2. 또는 친구톡 + 이메일 하이브리드 방식 구현
3. 친구 추가 프로세스 자동화 방안 검토

---

**문서 버전**: 1.0  
**최종 업데이트**: 2024-01-15
