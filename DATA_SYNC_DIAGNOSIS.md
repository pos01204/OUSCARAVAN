# 데이터 동기화 점검 및 수정 보고서

## 📋 개요

게스트 페이지와 관리자 페이지 간 데이터 동기화 문제를 점검하고 수정한 결과를 정리합니다.

## 🔍 발견된 문제점

### 1. 체크인 데이터 동기화 문제

**문제점:**
- 게스트 페이지에서 체크인 클릭 시 `sendCheckInToN8N`만 호출하여 n8n 웹훅으로만 전송
- Railway 백엔드의 `/api/guest/:token/checkin` API를 호출하지 않음
- 따라서 데이터베이스에 체크인 상태가 저장되지 않아 관리자 페이지에서 확인 불가

**영향:**
- 관리자 페이지에서 체크인 상태를 확인할 수 없음
- 예약 상태가 `checked_in`으로 업데이트되지 않음

### 2. 방 배정 수정 데이터 동기화 문제

**문제점:**
- 관리자 페이지에서 방 배정을 수정하면 Railway 백엔드에 저장됨
- 하지만 게스트 페이지는 서버 컴포넌트에서 한 번만 데이터를 가져옴
- 클라이언트에서 실시간으로 업데이트되지 않음
- 게스트 페이지를 새로고침해야 변경사항이 반영됨

**영향:**
- 관리자가 방 배정을 수정해도 게스트 페이지에 즉시 반영되지 않음
- 사용자 경험 저하

## ✅ 수정 완료 사항

### 1. 체크인 데이터베이스 저장 기능 추가

**수정 내용:**
- `CheckInOut.tsx` 컴포넌트에 `token` prop 추가
- 체크인 시 Railway 백엔드 API (`apiCheckIn`) 호출 추가
- 체크인 처리 순서:
  1. Railway 백엔드에 체크인 상태 저장
  2. 로컬 스토어 업데이트
  3. n8n 웹훅으로 알림 전송 (비동기, 실패해도 체크인은 저장됨)

**수정된 파일:**
- `components/features/CheckInOut.tsx`
  - `token` prop 추가
  - `apiCheckIn`, `apiCheckOut` import 추가
  - `handleCheckIn`, `handleCheckout`에서 Railway 백엔드 API 호출 추가
  - 에러 처리 및 로딩 상태 추가
- `components/guest/GuestHomeContent.tsx`
  - `CheckInOut` 컴포넌트에 `token` prop 전달

### 2. 게스트 페이지 실시간 데이터 갱신 기능 추가

**수정 내용:**
- `GuestReservationInfo` 컴포넌트 생성
  - 30초마다 자동으로 예약 정보 갱신
  - 방 배정 변경사항을 자동으로 반영
  - 갱신 중 상태 표시
- 게스트 레이아웃에서 `GuestReservationInfo` 사용

**수정된 파일:**
- `components/guest/GuestReservationInfo.tsx` (신규)
  - 주기적 데이터 갱신 로직
  - 예약 정보 표시 (방 배정, 체크인/체크아웃, 총 결제금액)
- `app/guest/[token]/layout.tsx`
  - 정적 예약 정보 표시를 `GuestReservationInfo` 컴포넌트로 교체

## 📊 수정 전후 데이터 흐름

### 체크인 데이터 흐름 (수정 후)

```
게스트 페이지 체크인 클릭
  ↓
1. Railway 백엔드 API 호출
   POST /api/guest/:token/checkin
   → PostgreSQL에 체크인 로그 저장
   → 예약 상태를 'checked_in'으로 업데이트
  ↓
2. 로컬 스토어 업데이트
   → UI 즉시 반영
  ↓
3. n8n 웹훅 호출 (비동기)
   → 알림 발송
  ↓
관리자 페이지에서 체크인 상태 확인 가능 ✅
```

### 방 배정 수정 데이터 흐름 (수정 후)

```
관리자 페이지에서 방 배정 수정
  ↓
Railway 백엔드 API 호출
  PATCH /api/admin/reservations/:id
  → PostgreSQL에 방 배정 정보 업데이트
  ↓
게스트 페이지 자동 갱신 (30초마다)
  GET /api/guest/:token
  → 최신 예약 정보 조회
  → 방 배정 변경사항 자동 반영 ✅
```

## 🔄 데이터 동기화 메커니즘

### 1. 체크인/체크아웃 동기화

- **게스트 → 관리자**: Railway 백엔드 API를 통해 즉시 동기화
- **저장 위치**: PostgreSQL `check_in_out_logs` 테이블 및 `reservations.status` 필드
- **관리자 확인**: 예약 목록에서 상태 필터링으로 확인 가능

### 2. 방 배정 동기화

- **관리자 → 게스트**: 30초마다 자동 갱신
- **저장 위치**: PostgreSQL `reservations.assigned_room` 필드
- **게스트 확인**: 예약 정보 헤더에서 자동으로 업데이트된 방 번호 확인 가능

### 3. 주문 동기화

- **게스트 → 관리자**: Railway 백엔드 API를 통해 즉시 동기화
- **저장 위치**: PostgreSQL `orders` 테이블
- **관리자 확인**: 주문 관리 페이지에서 즉시 확인 가능

## 📝 테스트 체크리스트

### 체크인 동기화 테스트

- [ ] 게스트 페이지에서 체크인 클릭
- [ ] Railway 백엔드에 체크인 상태 저장 확인
- [ ] 관리자 페이지에서 예약 상태가 'checked_in'으로 변경되는지 확인
- [ ] 예약 목록에서 체크인 필터링이 정상 작동하는지 확인

### 방 배정 동기화 테스트

- [ ] 관리자 페이지에서 방 배정 수정
- [ ] Railway 백엔드에 방 배정 정보 저장 확인
- [ ] 게스트 페이지에서 30초 이내에 방 배정 변경사항이 자동 반영되는지 확인
- [ ] 게스트 페이지 예약 정보 헤더에 변경된 방 번호가 표시되는지 확인

### 주문 동기화 테스트

- [ ] 게스트 페이지에서 주문 생성
- [ ] Railway 백엔드에 주문 저장 확인
- [ ] 관리자 페이지에서 주문 목록에 즉시 표시되는지 확인

## 🚨 알려진 이슈 및 개선 사항

### 현재 상태

1. **체크인 동기화**: ✅ 완료
   - Railway 백엔드에 체크인 상태가 정상적으로 저장됨
   - 관리자 페이지에서 체크인 상태 확인 가능

2. **방 배정 동기화**: ✅ 완료
   - 30초마다 자동 갱신으로 방 배정 변경사항 반영
   - 게스트 페이지에서 최신 방 배정 정보 확인 가능

### 개선 제안

1. **실시간 업데이트 (WebSocket 또는 Server-Sent Events)**
   - 현재는 30초마다 폴링 방식으로 갱신
   - WebSocket 또는 SSE를 사용하면 즉시 업데이트 가능
   - 우선순위: 중간

2. **수동 갱신 버튼 추가**
   - 사용자가 원할 때 수동으로 갱신할 수 있는 버튼 추가
   - 우선순위: 낮음

3. **갱신 주기 조정**
   - 현재 30초 주기, 필요에 따라 조정 가능
   - 우선순위: 낮음

## 📌 결론

### 구현 완료 사항

✅ **체크인 데이터베이스 저장**: 게스트 페이지에서 체크인 시 Railway 백엔드에 저장되어 관리자 페이지에서 확인 가능

✅ **방 배정 실시간 갱신**: 관리자 페이지에서 방 배정 수정 시 게스트 페이지에서 30초 이내에 자동 반영

✅ **주문 동기화**: 게스트 페이지에서 주문 생성 시 관리자 페이지에서 즉시 확인 가능

### 데이터 동기화 상태

| 기능 | 게스트 → 관리자 | 관리자 → 게스트 | 상태 |
|------|---------------|---------------|------|
| 체크인 | ✅ 즉시 동기화 | N/A | 완료 |
| 체크아웃 | ✅ 즉시 동기화 | N/A | 완료 |
| 방 배정 | N/A | ✅ 30초 자동 갱신 | 완료 |
| 주문 | ✅ 즉시 동기화 | N/A | 완료 |

### 다음 단계

1. 실시간 업데이트 기능 추가 (WebSocket/SSE) - 선택사항
2. 수동 갱신 버튼 추가 - 선택사항
3. 갱신 주기 조정 - 선택사항
