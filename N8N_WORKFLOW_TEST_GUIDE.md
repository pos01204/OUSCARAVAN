# n8n 워크플로우 테스트 가이드 (알림톡 발송 전 단계)

## 📋 개요

알림톡 발송 전 단계까지의 전체 플로우가 제대로 설정되었는지 테스트하는 가이드입니다.

**테스트 범위:**
- Gmail Trigger (이메일 수신 감지)
- IF 노드 (예약 확정/취소 구분)
- Code 노드 (이메일 파싱)
- Set 노드 (데이터 정리)
- Code 노드 (고유 링크 생성)
- Code 노드 (전화번호 포맷 변환)

---

## 🎯 테스트 전략

### 전략 1: 단계별 노드 테스트 (권장)
각 노드를 하나씩 실행하여 결과를 확인합니다.

### 전략 2: 전체 플로우 테스트
Manual Trigger를 사용하여 전체 플로우를 한 번에 테스트합니다.

---

## 1단계: Gmail Trigger 테스트

### 1-1. Gmail Trigger 노드 확인

1. n8n 워크플로우에서 **Gmail Trigger** 노드 클릭
2. **"Execute Node"** 클릭
3. 결과 확인:
   - 이메일이 감지되면 데이터가 표시됨
   - 이메일이 없으면 빈 배열 `[]` 표시

### 1-2. 테스트 이메일 발송

**실제 이메일로 테스트:**

1. 테스트용 Gmail 계정에서 자신의 Gmail로 이메일 발송
2. 제목: `[네이버 예약] 예약이 확정되었습니다.`
3. 발신자: `reservation@naver.com` (또는 실제 네이버 예약 이메일)
4. n8n 워크플로우 자동 실행 확인

**또는 Manual Trigger로 테스트:**

1. **Gmail Trigger** 노드를 **Manual Trigger**로 임시 변경
2. 테스트 데이터 입력
3. 실행

---

## 2단계: IF 노드 테스트

### 2-1. IF 노드 설정 확인

**IF 노드 설정:**
- **Value 1**: `{{ $json.subject }}`
- **Operation**: `Contains`
- **Value 2**: `확정`

### 2-2. IF 노드 테스트

**Option A: 실제 데이터로 테스트**

1. Gmail Trigger가 이메일을 감지한 경우
2. **IF 노드**에서 **"Execute Node"** 클릭
3. 결과 확인:
   - **True** 출력: 제목에 "확정"이 포함된 경우
   - **False** 출력: 제목에 "확정"이 없는 경우

**Option B: 수동 데이터로 테스트**

1. **IF 노드** 앞에 **Code 노드** 추가 (테스트용)
2. 테스트 데이터 생성:

```javascript
// 테스트 데이터 생성
const testData = {
  subject: "[네이버 예약] 예약이 확정되었습니다.",
  from: "reservation@naver.com",
  body: "예약 완료 이메일 내용..."
};

return { json: testData };
```

3. **IF 노드**에서 **"Execute Node"** 클릭
4. True/False 출력 확인

---

## 3단계: Code 노드 (이메일 파싱) 테스트

### 3-1. Code 노드 확인

**IF 노드의 True 출력**에 연결된 Code 노드를 확인합니다.

### 3-2. Code 노드 테스트

1. **Code 노드**에서 **"Execute Node"** 클릭
2. 결과 확인:

**예상 결과:**
```json
{
  "guest": "홍길동",
  "reservationNumber": "1122269060",
  "checkin": "2026-01-15",
  "checkout": "2026-01-17",
  "room": "Airstream1",
  "amount": "180,000",
  "phone": "010-1234-5678"
}
```

### 3-3. 파싱 오류 확인

**문제가 있는 경우:**
- 이메일 본문 형식 확인
- 정규식 패턴 확인
- 파싱 로직 수정

---

## 4단계: Set 노드 테스트

### 4-1. Set 노드 확인

**Set 노드 설정 확인:**
- 데이터 필드 매핑 확인
- 필수 필드 포함 확인

### 4-2. Set 노드 테스트

1. **Set 노드**에서 **"Execute Node"** 클릭
2. 결과 확인:
   - 모든 필드가 올바르게 매핑되었는지 확인
   - 데이터 형식 확인

---

## 5단계: Code 노드 (고유 링크 생성) 테스트

### 5-1. Code 노드 확인

**고유 링크 생성 로직 확인:**

```javascript
// 고유 토큰 생성
const token = Buffer.from(`${$json.guest}-${$json.room}-${Date.now()}`)
  .toString('base64')
  .replace(/[+/=]/g, '')
  .substring(0, 24);

const baseUrl = $env.WEB_APP_URL || 'https://ouscaravan.vercel.app';
const link = `${baseUrl}/home?guest=${encodeURIComponent($json.guest)}&room=${encodeURIComponent($json.room)}&checkin=${$json.checkin || ''}&checkout=${$json.checkout || ''}&token=${token}`;

return {
  ...$json,
  token: token,
  link: link
};
```

### 5-2. Code 노드 테스트

1. **Code 노드**에서 **"Execute Node"** 클릭
2. 결과 확인:

**예상 결과:**
```json
{
  "guest": "홍길동",
  "room": "Airstream1",
  "checkin": "2026-01-15",
  "checkout": "2026-01-17",
  "token": "생성된_토큰",
  "link": "https://ouscaravan.vercel.app/home?guest=홍길동&room=A1&checkin=2026-01-15&checkout=2026-01-17&token=xxx"
}
```

### 5-3. 링크 유효성 확인

1. 생성된 링크 복사
2. 브라우저에서 접속 테스트
3. 웹 앱이 정상적으로 로드되는지 확인

---

## 6단계: Code 노드 (전화번호 포맷 변환) 테스트

### 6-1. Code 노드 확인

**전화번호 포맷 변환 로직 확인:**

```javascript
let phone = $input.item.json.phone || '';
phone = phone.replace(/[-\s()]/g, '');

if (phone.startsWith('010')) {
  phone = phone.substring(0, 11);
}

return {
  ...$input.item.json,
  phone: phone
};
```

### 6-2. Code 노드 테스트

**다양한 전화번호 형식 테스트:**

1. **"Execute Node"** 클릭
2. 입력 데이터 확인:
   - `010-1234-5678` → `01012345678` ✅
   - `010 1234 5678` → `01012345678` ✅
   - `(010) 1234-5678` → `01012345678` ✅
   - `01012345678` → `01012345678` ✅

3. 결과 확인:

**예상 결과:**
```json
{
  "phone": "01012345678",
  "phone_formatted": "01012345678"
}
```

---

## 7단계: 전체 플로우 통합 테스트

### 7-1. Manual Trigger 사용 (권장)

**Gmail Trigger를 Manual Trigger로 임시 변경:**

1. **Gmail Trigger** 노드 삭제 또는 비활성화
2. **Manual Trigger** 노드 추가
3. 테스트 데이터 입력:

```json
{
  "subject": "[네이버 예약] 예약이 확정되었습니다.",
  "from": "reservation@naver.com",
  "body": "예약자명: 홍길동님\n예약번호: 1122269060\n체크인: 2026-01-15\n체크아웃: 2026-01-17\n객실: Airstream1\n결제금액: 180,000원\n전화번호: 010-1234-5678"
}
```

4. **"Execute Workflow"** 클릭
5. 각 노드 실행 결과 확인

### 7-2. 실제 이메일로 테스트

1. 테스트용 네이버 예약 완료 이메일 발송
2. Gmail Trigger가 자동으로 감지
3. 각 노드 실행 결과 확인

---

## 8단계: 각 노드별 상세 테스트 방법

### 8-1. Gmail Trigger 노드

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:
   - 이메일이 있으면: 이메일 데이터 표시
   - 이메일이 없으면: 빈 배열

**확인 사항:**
- [ ] 필터가 올바르게 설정되었는지
- [ ] 이메일이 감지되는지
- [ ] 이메일 데이터 형식이 올바른지

### 8-2. IF 노드

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:
   - **True** 출력: 예약 확정 이메일
   - **False** 출력: 예약 취소 이메일

**확인 사항:**
- [ ] 조건이 올바르게 설정되었는지
- [ ] True/False 분기가 올바른지

### 8-3. Code 노드 (이메일 파싱)

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:

**예상 출력:**
```json
{
  "guest": "홍길동",
  "reservationNumber": "1122269060",
  "checkin": "2026-01-15",
  "checkout": "2026-01-17",
  "room": "Airstream1",
  "amount": "180,000",
  "phone": "010-1234-5678"
}
```

**확인 사항:**
- [ ] 게스트 이름 추출 정확성
- [ ] 예약번호 추출 정확성
- [ ] 날짜 추출 정확성
- [ ] 객실 정보 추출 정확성
- [ ] 전화번호 추출 정확성

### 8-4. Set 노드

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:
   - 모든 필드가 올바르게 매핑되었는지

**확인 사항:**
- [ ] 필드 매핑 정확성
- [ ] 데이터 형식 일관성

### 8-5. Code 노드 (고유 링크 생성)

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:

**예상 출력:**
```json
{
  "guest": "홍길동",
  "room": "Airstream1",
  "checkin": "2026-01-15",
  "checkout": "2026-01-17",
  "token": "생성된_고유_토큰",
  "link": "https://ouscaravan.vercel.app/home?guest=홍길동&room=A1&checkin=2026-01-15&checkout=2026-01-17&token=xxx"
}
```

**확인 사항:**
- [ ] 토큰이 생성되는지
- [ ] 링크가 올바르게 생성되는지
- [ ] 링크가 웹 앱에서 정상 동작하는지

### 8-6. Code 노드 (전화번호 포맷 변환)

**테스트 방법:**

1. **"Execute Node"** 클릭
2. 결과 확인:

**예상 출력:**
```json
{
  "phone": "01012345678",
  "phone_formatted": "01012345678"
}
```

**확인 사항:**
- [ ] 하이픈이 제거되는지
- [ ] 전화번호 형식이 올바른지 (11자리)
- [ ] 유효하지 않은 전화번호 처리

---

## 9단계: 테스트 데이터 준비

### 9-1. 테스트용 이메일 본문

**예약 확정 이메일 예시:**

```
예약자명: 홍길동님
예약번호: 1122269060
체크인: 2026-01-15
체크아웃: 2026-01-17
객실: Airstream1
결제금액: 180,000원
전화번호: 010-1234-5678
```

### 9-2. Manual Trigger 테스트 데이터

**JSON 형식:**

```json
{
  "subject": "[네이버 예약] 예약이 확정되었습니다.",
  "from": "reservation@naver.com",
  "body": "예약자명: 홍길동님\n예약번호: 1122269060\n체크인: 2026-01-15\n체크아웃: 2026-01-17\n객실: Airstream1\n결제금액: 180,000원\n전화번호: 010-1234-5678",
  "htmlBody": "<html><body>예약자명: 홍길동님<br>예약번호: 1122269060<br>체크인: 2026-01-15<br>체크아웃: 2026-01-17<br>객실: Airstream1<br>결제금액: 180,000원<br>전화번호: 010-1234-5678</body></html>"
}
```

---

## 10단계: 단계별 테스트 체크리스트

### Gmail Trigger
- [ ] 이메일 감지 확인
- [ ] 필터 작동 확인
- [ ] 이메일 데이터 형식 확인

### IF 노드
- [ ] True 분기 작동 확인 (예약 확정)
- [ ] False 분기 작동 확인 (예약 취소)
- [ ] 조건 로직 정확성 확인

### Code 노드 (이메일 파싱)
- [ ] 게스트 이름 추출 확인
- [ ] 예약번호 추출 확인
- [ ] 체크인/체크아웃 날짜 추출 확인
- [ ] 객실 정보 추출 확인
- [ ] 결제금액 추출 확인
- [ ] 전화번호 추출 확인

### Set 노드
- [ ] 필드 매핑 확인
- [ ] 데이터 형식 확인

### Code 노드 (고유 링크 생성)
- [ ] 토큰 생성 확인
- [ ] 링크 생성 확인
- [ ] 링크 유효성 확인 (브라우저에서 테스트)

### Code 노드 (전화번호 포맷 변환)
- [ ] 하이픈 제거 확인
- [ ] 전화번호 형식 확인 (11자리)
- [ ] 다양한 형식 테스트

---

## 11단계: 문제 해결

### 문제 1: Gmail Trigger가 이메일을 감지하지 않음

**원인:**
- 필터 설정 오류
- Gmail 인증 오류
- 이메일이 실제로 없음

**해결:**
1. 필터 설정 확인:
   - `subject:[네이버 예약]`
   - `from:naver.com`
2. Gmail 인증 재설정
3. 테스트 이메일 발송 확인

### 문제 2: IF 노드가 올바르게 분기하지 않음

**원인:**
- 조건 설정 오류
- 데이터 형식 오류

**해결:**
1. 조건 확인:
   - Value 1: `{{ $json.subject }}`
   - Operation: `Contains`
   - Value 2: `확정`
2. 입력 데이터 확인
3. 조건 로직 수정

### 문제 3: 이메일 파싱이 실패함

**원인:**
- 이메일 본문 형식 변경
- 정규식 패턴 오류
- 필수 필드 누락

**해결:**
1. 이메일 본문 형식 확인
2. 정규식 패턴 수정
3. 파싱 로직 개선

### 문제 4: 고유 링크가 생성되지 않음

**원인:**
- 환경 변수 오류
- URL 생성 로직 오류

**해결:**
1. 환경 변수 확인 (`WEB_APP_URL`)
2. URL 생성 로직 확인
3. 토큰 생성 로직 확인

### 문제 5: 전화번호 포맷 변환이 실패함

**원인:**
- 전화번호 추출 실패
- 포맷 변환 로직 오류

**해결:**
1. 전화번호 추출 확인
2. 포맷 변환 로직 수정
3. 다양한 형식 테스트

---

## 12단계: 최종 검증

### 12-1. 전체 플로우 실행

1. Manual Trigger로 전체 플로우 실행
2. 각 노드 실행 결과 확인
3. 최종 출력 데이터 확인

### 12-2. 최종 출력 데이터 확인

**예상 최종 출력:**

```json
{
  "guest": "홍길동",
  "reservationNumber": "1122269060",
  "checkin": "2026-01-15",
  "checkout": "2026-01-17",
  "room": "Airstream1",
  "amount": "180,000",
  "phone": "01012345678",
  "token": "생성된_고유_토큰",
  "link": "https://ouscaravan.vercel.app/home?guest=홍길동&room=A1&checkin=2026-01-15&checkout=2026-01-17&token=xxx"
}
```

### 12-3. 링크 테스트

1. 생성된 링크 복사
2. 브라우저에서 접속
3. 웹 앱이 정상적으로 로드되는지 확인
4. 게스트 정보가 올바르게 표시되는지 확인

---

## 📋 최종 체크리스트

### 각 노드 테스트
- [ ] Gmail Trigger 테스트 완료
- [ ] IF 노드 테스트 완료
- [ ] Code 노드 (이메일 파싱) 테스트 완료
- [ ] Set 노드 테스트 완료
- [ ] Code 노드 (고유 링크 생성) 테스트 완료
- [ ] Code 노드 (전화번호 포맷 변환) 테스트 완료

### 통합 테스트
- [ ] 전체 플로우 테스트 완료
- [ ] 최종 출력 데이터 확인
- [ ] 링크 유효성 확인

### 데이터 검증
- [ ] 모든 필수 필드 추출 확인
- [ ] 데이터 형식 정확성 확인
- [ ] 링크 생성 정확성 확인
- [ ] 전화번호 포맷 정확성 확인

---

## 🎯 다음 단계

### 테스트 완료 후

1. **SolAPI 노드 추가**
   - SolAPI 서비스 신청 완료 후
   - 템플릿 승인 완료 후
   - SolAPI 노드 설정

2. **최종 통합 테스트**
   - 전체 플로우 테스트
   - 알림톡 발송 확인

---

**문서 버전**: 1.0  
**최종 업데이트**: 2024-01-15
