# 전화번호 추출 문제 해결 가이드

## 🔍 문제 진단

**증상:**
- 예약 확정 이메일에는 전화번호가 포함되어 있지 않음
- 전화번호는 네이버 예약 관리 페이지에서만 확인 가능
- 알림톡 발송을 위해서는 전화번호가 필수

**영향:**
- 현재 워크플로우에서 전화번호를 추출할 수 없음
- 알림톡 발송 불가능

---

## 🔧 해결 방법

### 방법 1: 네이버 예약 관리 페이지에서 전화번호 조회 (권장)

네이버 예약 관리 페이지에 로그인하여 예약번호로 전화번호를 조회합니다.

#### 1-1. n8n HTTP Request 노드 추가

**Code 노드 (이메일 파싱)** 다음에 **HTTP Request 노드** 추가:

**설정:**
- **Method**: `GET` 또는 `POST`
- **URL**: 네이버 예약 관리 페이지 API 엔드포인트
- **Authentication**: Cookie 또는 Bearer Token

**문제점:**
- 네이버 예약 관리 페이지는 공개 API를 제공하지 않을 수 있음
- 로그인 세션 관리 필요
- 웹 스크래핑이 필요할 수 있음

#### 1-2. Puppeteer/Playwright 사용 (고급)

n8n에서 브라우저 자동화를 사용하여 네이버 예약 관리 페이지에 접속:

1. **Puppeteer** 또는 **Playwright** 노드 사용
2. 네이버 예약 관리 페이지 로그인
3. 예약번호로 검색
4. 전화번호 추출

**단점:**
- 복잡한 설정 필요
- 로그인 자동화 필요
- 느린 처리 속도

---

### 방법 2: 이메일 주소로 알림톡 발송 시도 (제한적)

일부 알림톡 서비스는 이메일 주소로도 발송을 지원할 수 있습니다.

**문제점:**
- 대부분의 알림톡 서비스는 전화번호만 지원
- SolAPI도 전화번호 필수

---

### 방법 3: 전화번호 수집 프로세스 추가

예약 확정 이메일에는 전화번호가 없지만, 다른 방법으로 수집:

#### 3-1. 웹 앱에서 전화번호 입력 유도

1. 예약 확정 알림톡 발송 시 전화번호 없이 링크만 발송
2. 웹 앱에서 전화번호 입력 요청
3. 전화번호 입력 후 알림톡 재발송

**워크플로우:**
```
[예약 확정 이메일]
  ↓
[이메일 파싱]
  ↓
[전화번호 없음 확인]
  ↓
[웹 앱 링크 생성]
  ↓
[이메일로 링크 발송] (전화번호 대신)
  ↓
[게스트가 웹 앱에서 전화번호 입력]
  ↓
[전화번호 저장]
  ↓
[알림톡 발송]
```

#### 3-2. 예약 시점에 전화번호 수집

네이버 예약 시 전화번호를 수집하는 방법:

1. 네이버 예약 관리 페이지에서 예약 시 전화번호 필수 입력 설정
2. 예약 완료 후 전화번호를 별도로 저장
3. 예약 확정 이메일과 매칭

---

### 방법 4: 네이버 예약 관리 페이지 API 활용 (가능한 경우)

네이버 예약 관리 페이지가 내부적으로 API를 사용한다면, 해당 API를 활용:

#### 4-1. 네트워크 요청 확인

1. 브라우저 개발자 도구 열기
2. 네이버 예약 관리 페이지 접속
3. 예약 상세 정보 열기
4. Network 탭에서 API 요청 확인
5. 예약번호로 전화번호를 조회하는 API 엔드포인트 찾기

#### 4-2. n8n HTTP Request 노드 설정

찾은 API 엔드포인트를 사용:

**HTTP Request 노드:**
- **Method**: `GET` 또는 `POST`
- **URL**: API 엔드포인트
- **Headers**: 
  - `Authorization`: Bearer Token 또는 Cookie
  - `Content-Type`: `application/json`
- **Body** (POST인 경우):
```json
{
  "reservationNumber": "{{ $json.reservationNumber }}"
}
```

---

### 방법 5: 전화번호 없이 알림톡 발송 (대안)

전화번호가 없어도 알림톡을 발송할 수 있는 방법:

#### 5-1. 이메일로 알림 발송

알림톡 대신 이메일로 알림 발송:

1. **Email 노드** 추가
2. 예약 확정 이메일의 발신자에게 알림 이메일 발송
3. 웹 앱 링크 포함

#### 5-2. 웹 앱 푸시 알림 (PWA)

PWA 기능을 활용하여 웹 앱 푸시 알림:

1. 게스트가 웹 앱에 접속
2. 브라우저 알림 권한 요청
3. 예약 확정 시 푸시 알림 발송

---

## 🎯 권장 해결 방법

### 단기 해결책: 이메일로 링크 발송

**워크플로우 수정:**

1. **Code 노드 (이메일 파싱)** 다음에 **IF 노드** 추가
2. **IF 노드 조건**: 전화번호가 있는지 확인
3. **True Branch**: 전화번호가 있으면 → 알림톡 발송
4. **False Branch**: 전화번호가 없으면 → 이메일로 링크 발송

**이메일 발송 노드 (False Branch):**

```javascript
// 이메일 발송 (전화번호 없을 때)
const emailContent = `
안녕하세요 ${$json.guestName}님,

OUSCARAVAN 예약이 완료되었습니다!

예약번호: ${$json.reservationNumber}
체크인: ${$json.checkin}
체크아웃: ${$json.checkout}
객실: ${$json.room}

컨시어지 서비스를 이용하시려면 아래 링크를 클릭하세요:
${$json.link}

감사합니다.
`;

return {
  to: $json.email,
  subject: 'OUSCARAVAN 예약 완료 안내',
  body: emailContent
};
```

### 장기 해결책: 네이버 예약 관리 페이지 연동

1. 네이버 예약 관리 페이지 API 엔드포인트 확인
2. n8n HTTP Request 노드로 예약번호로 전화번호 조회
3. 조회한 전화번호로 알림톡 발송

---

## 📋 수정된 워크플로우 구조

```
[Gmail Trigger]
  ↓
[IF: 예약 확정/취소 구분]
  ↓ (True: 확정)
[Code: 이메일 파싱]
  ↓
[IF: 전화번호 확인]
  ├─ True (전화번호 있음)
  │   ↓
  │   [Set: 데이터 정리]
  │   ↓
  │   [Code: 고유 링크 생성]
  │   ↓
  │   [Code: 전화번호 포맷 변환]
  │   ↓
  │   [SolAPI: 알림톡 발송]
  │
  └─ False (전화번호 없음)
      ↓
      [Set: 데이터 정리]
      ↓
      [Code: 고유 링크 생성]
      ↓
      [Email: 링크 발송]
```

---

## 🔍 네이버 예약 관리 페이지 API 확인 방법

### 1단계: 브라우저 개발자 도구 열기

1. 네이버 예약 관리 페이지 접속
2. F12 또는 우클릭 → "검사" 클릭
3. **Network** 탭 열기

### 2단계: 예약 상세 정보 열기

1. 예약 목록에서 예약 클릭
2. 예약 상세 정보 팝업 열기
3. Network 탭에서 API 요청 확인

### 3단계: API 엔드포인트 찾기

**찾아야 할 것:**
- 예약번호로 예약 정보를 조회하는 API
- 전화번호가 포함된 응답

**예상 엔드포인트:**
```
GET /api/reservations/{reservationNumber}
또는
POST /api/reservations/search
```

### 4단계: n8n HTTP Request 노드 설정

찾은 API를 n8n에 연동:

**HTTP Request 노드:**
- **Method**: `GET` 또는 `POST`
- **URL**: `https://partner.booking.naver.com/api/reservations/{{ $json.reservationNumber }}`
- **Authentication**: Cookie 또는 Bearer Token
- **Headers**: 
  - `Cookie`: 네이버 로그인 쿠키
  - 또는 `Authorization`: Bearer Token

---

## 💡 임시 해결책: 수동 처리

전화번호가 필요한 경우:

1. 예약 확정 이메일 수신
2. 네이버 예약 관리 페이지에서 예약번호로 검색
3. 전화번호 확인
4. 수동으로 알림톡 발송

**자동화 불가능하지만, 최소한의 수동 작업으로 처리 가능**

---

## 📋 체크리스트

### 즉시 적용 가능
- [ ] IF 노드 추가 (전화번호 확인)
- [ ] False Branch에 이메일 발송 노드 추가
- [ ] 이메일 내용에 웹 앱 링크 포함

### 장기 해결책
- [ ] 네이버 예약 관리 페이지 API 확인
- [ ] HTTP Request 노드로 전화번호 조회
- [ ] 조회한 전화번호로 알림톡 발송

---

**문서 버전**: 1.0  
**최종 업데이트**: 2024-01-15
